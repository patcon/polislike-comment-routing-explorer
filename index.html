<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Polis Metric Playground</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 2rem;
      background: #f7f7f7;
      color: #222;
    }
    input, textarea {
      width: 100%;
      margin: 0.5rem 0 1rem 0;
      padding: 0.4rem;
      font-family: monospace;
    }
    textarea {
      height: 10rem;
    }
    .link-box {
      margin-top: 0.5rem;
      background: #fff;
      padding: 0.5rem;
      border-radius: 0.4rem;
      box-shadow: 0 0 3px rgba(0,0,0,0.1);
    }
    .slider-box {
      margin: 2rem 0;
    }
    .result {
      background: #fff;
      padding: 1rem;
      border-radius: 0.4rem;
      margin-top: 1rem;
      box-shadow: 0 0 3px rgba(0,0,0,0.1);
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1>Polis Metric Playground</h1>

  <h3>1️⃣ Enter a Polis Conversation URL</h3>
  <input id="convInput" type="text" placeholder="https://pol.is/6jrufhr6dp" />

  <div id="apiLinks" class="link-box" style="display:none;">
    <p>Fetch data manually with <code>curl</code> or open directly:</p>
    <ul>
      <li><a id="commentsLink" href="#" target="_blank" rel="noopener noreferrer">Comments API</a></li>
      <li><a id="mathLink" href="#" target="_blank" rel="noopener noreferrer">Math PCA2 API</a></li>
    </ul>
    <p>Example <code>curl</code> commands:</p>
    <pre id="curlExamples"></pre>
  </div>

  <h3>2️⃣ Paste API JSON Results</h3>
  <label>Comments JSON:</label>
  <textarea id="commentsText" placeholder="Paste JSON from /comments"></textarea>

<label>Math PCA2 JSON:</label>

  <textarea id="mathText" placeholder="Paste JSON from /math/pca2"></textarea>

<button id="loadBtn">Load Data</button>

  <div id="loadStatus" class="result" style="display:none;"></div>

  <div class="slider-box">
    <h3>3️⃣ Explore Example Metrics</h3>
    <div id="agreeSlider"></div>
    <p>Agree: <span id="agreeVal"></span></p>
    <div id="disagreeSlider"></div>
    <p>Disagree: <span id="disagreeVal"></span></p>
    <div id="totalSlider"></div>
    <p>Total: <span id="totalVal"></span></p>
    <div id="extremitySlider"></div>
    <p>Extremity: <span id="extremityVal"></span></p>
  </div>

  <div id="metricResult" class="result"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>

  <script>
    // --- STEP 1: Build clickable URLs when user enters a conversation ID ---
    const convInput = document.getElementById("convInput");
    const apiLinks = document.getElementById("apiLinks");
    const commentsLink = document.getElementById("commentsLink");
    const mathLink = document.getElementById("mathLink");
    const curlExamples = document.getElementById("curlExamples");

    convInput.addEventListener("input", () => {
      const val = convInput.value.trim();
      const match = val.match(/([a-z0-9]{10})$/i);
      if (!match) {
        apiLinks.style.display = "none";
        return;
      }
      const cid = match[1];
      const commentsUrl = `https://pol.is/api/v3/comments?conversation_id=${cid}&moderation=true&include_voting_patterns=true`;
      const mathUrl = `https://pol.is/api/v3/math/pca2?conversation_id=${cid}`;
      commentsLink.href = commentsUrl;
      mathLink.href = mathUrl;
      curlExamples.textContent =
`curl -s "${commentsUrl}" | jq '.[0] | map_values(type)'
curl -s "${mathUrl}" | jq '. | map_values(type)'`;
      apiLinks.style.display = "block";
    });

    // --- STEP 2: Load pasted JSON ---
    const loadBtn = document.getElementById("loadBtn");
    const loadStatus = document.getElementById("loadStatus");
    let commentsData = null, mathData = null;

    loadBtn.addEventListener("click", () => {
      try {
        commentsData = JSON.parse(document.getElementById("commentsText").value);
        mathData = JSON.parse(document.getElementById("mathText").value);
        loadStatus.textContent = `Loaded ${commentsData.length} comments and ${Object.keys(mathData).length} math fields.`;
        loadStatus.style.display = "block";
      } catch (e) {
        loadStatus.textContent = "❌ Error parsing JSON. Check your paste.";
        loadStatus.style.display = "block";
      }
    });

    // --- STEP 3: noUiSliders for interactive exploration ---
    const agreeSlider = document.getElementById("agreeSlider");
    const disagreeSlider = document.getElementById("disagreeSlider");
    const totalSlider = document.getElementById("totalSlider");
    const extremitySlider = document.getElementById("extremitySlider");

    function makeSlider(el, min, max, start, outEl) {
      noUiSlider.create(el, { start, connect: "lower", range: { min, max }, step: 1 });
      el.noUiSlider.on("update", (values) => {
        document.getElementById(outEl).textContent = values[0];
        updateMetrics();
      });
    }

    makeSlider(agreeSlider, 0, 100, 10, "agreeVal");
    makeSlider(disagreeSlider, 0, 100, 5, "disagreeVal");
    makeSlider(totalSlider, 0, 200, 50, "totalVal");
    noUiSlider.create(extremitySlider, { start: [0.5], connect: "lower", range: { min: 0, max: 2 }, step: 0.01 });
    extremitySlider.noUiSlider.on("update", (values) => {
      document.getElementById("extremityVal").textContent = values[0];
      updateMetrics();
    });

    const metricResult = document.getElementById("metricResult");

    // --- STEP 4: Compute importance + priority metric for current slider values ---
    function probability(n, total, pseudo = 1) {
      return (n + pseudo) / (total + 3 * pseudo);
    }

    function importanceMetric(nAgree, nDisagree, nTotal, extremity, pseudoCount = 1) {
      const nPass = nTotal - (nAgree + nDisagree);
      const probAgree = probability(nAgree, nTotal, pseudoCount);
      const probPass = probability(nPass, nTotal, pseudoCount);
      const probEngagement = 1 - probPass;
      return probAgree * probEngagement * (1 + extremity);
    }

    function priorityMetric(isMeta, nAgree, nDisagree, nTotal, extremity, metaPriority = 7, pseudoCount = 1) {
      const importance = importanceMetric(nAgree, nDisagree, nTotal, extremity, pseudoCount);
      const NO_VOTES_SCALE_FACTOR = 9;
      const newnessScaleFactor = 1 + (NO_VOTES_SCALE_FACTOR - 1) * Math.pow(2, -(nTotal / 5));
      const priority = isMeta ? metaPriority : importance * newnessScaleFactor;
      return Math.pow(priority, 2);
    }

    function updateMetrics() {
      const nAgree = +agreeSlider.noUiSlider.get();
      const nDisagree = +disagreeSlider.noUiSlider.get();
      const nTotal = +totalSlider.noUiSlider.get();
      const extremity = +extremitySlider.noUiSlider.get();
      const imp = importanceMetric(nAgree, nDisagree, nTotal, extremity);
      const pri = priorityMetric(false, nAgree, nDisagree, nTotal, extremity);
      metricResult.textContent =
`importance: ${imp.toFixed(6)}
priority: ${pri.toFixed(6)}`;
    }

    updateMetrics();
  </script>

</body>
</html>

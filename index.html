<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Polis Metric Playground</title>
  <link href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css" rel="stylesheet">
  <style>
    body { font‑family: sans‑serif; padding: 2em; background: #fafafa; }
    details { background: #fff; border: 1px solid #ccc; padding: 1em; border‑radius: 6px; margin‑bottom: 1.5em; }
    .links { display: flex; gap: 1em; }
    .slider-wrapper { margin‑bottom: 2em; }
    #multiSlider, #extremitySlider { margin‑top: 1em; }
    .output { background: #fff; border: 1px solid #ccc; padding: 1em; border‑radius: 6px; }
    textarea { width: 48%; min‑height: 100px; margin‑top: 0.5em; }
    .textarea-container { display: flex; gap:1em; }
    .comments-table { max-height:200px; overflow-y:auto; border:1px solid #ccc; margin‑top:1em; }
    .comments-table table { width:100%; border-collapse: collapse; }
    .comments‑table th, .comments‑table td { border:1px solid #ddd; padding:4px 8px; }
    .comments‑table tr:hover { background:#f0f0f0; cursor:pointer; }
    button { margin‑top:0.5em; padding:0.5em 1em; cursor:pointer; }
    .c‑agree { background: green; }
    .c‑pass { background: yellow; }
    .c‑disagree { background: red; }
    .c‑empty { background: white; }
  </style>
</head>
<body>
  <h1>Polis Metric Playground</h1>
  <p>Experiment with sliders to see how values affect the Polis importance and priority metrics. Data fields persist between refreshes.</p>

  <details id="dataSection" open>
    <summary><strong>Load Polis Data</strong></summary>
    <label for="conversationId">Conversation ID:</label><br>
    <input type="text" id="conversationId" placeholder="e.g. 6bkf4ujff9" style="width:200px;"><br>
    <button id="loadData">Generate URLs</button>

    <div id="dataLinks" style="display:none; margin-top:1em;">
      <div class="links">
        <a id="commentsUrl" href="#" target="_blank" rel="noreferrer noopener">Comments JSON</a>
        <a id="pcaUrl" href="#" target="_blank" rel="noreferrer noopener">PCA2 JSON</a>
      </div>
      <div class="textarea-container">
        <textarea id="commentsInput" placeholder="Paste comments JSON here…"></textarea>
        <textarea id="pcaInput" placeholder="Paste PCA2 JSON here…"></textarea>
      </div>
      <button id="useData">Use Data</button>
      <div class="comments-table" id="commentsTableContainer"></div>
    </div>
  </details>

  <div class="slider-wrapper">
    <label>Response Distribution (green = agree, yellow = pass, red = disagree, white = remaining)</label>
    <div id="multiSlider"></div>
  </div>

  <div class="slider-wrapper">
    <label>Extremity Weight</label>
    <div id="extremitySlider"></div>
  </div>

  <div class="output">
    <strong>Values:</strong>
    <div id="values"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>
  <script>
    const multiSlider = document.getElementById('multiSlider');
    const extremitySlider = document.getElementById('extremitySlider');

    const savedConvoId = localStorage.getItem('conversationId') || '';
    const savedComments = localStorage.getItem('commentsJSON') || '';
    const savedPCA = localStorage.getItem('pcaJSON') || '';

    document.getElementById('conversationId').value = savedConvoId;
    document.getElementById('commentsInput').value = savedComments;
    document.getElementById('pcaInput').value = savedPCA;

    // Configure 4 handles: 0, agree, agree+pass, total – which gives 3 connecting segments
    noUiSlider.create(multiSlider, {
      start: [0, 20, 70, 100],
      connect: [false, true, true, true, false], // must have length = handles + 1 = 5
      tooltips: [true, true, true, true],
      range: { min: 0, max: 100 },
      step: 1
    });

    const updateConnectColors = () => {
      const connectElems = multiSlider.querySelectorAll('.noUi-connect');
      // With 5 connect booleans, there will be 5‑1=4 connects
      if (connectElems.length === 4) {
        connectElems[0].className = 'noUi-connect c-empty';      // between min and first handle
        connectElems[1].className = 'noUi-connect c-agree';
        connectElems[2].className = 'noUi-connect c-pass';
        connectElems[3].className = 'noUi-connect c-disagree';
      }
    };

    updateConnectColors();

    multiSlider.noUiSlider.on('update', (values) => {
      const v = values.map(Number);
      // differences for segments (skip the first segment maybe)
      const diffs = [
        v[1] - v[0],
        v[2] - v[1],
        v[3] - v[2]
      ];
      const tooltips = multiSlider.noUiSlider.getTooltips();
      // Skip first handle tooltip or use a dummy
      tooltips.forEach((tooltip, i) => {
        if (tooltip) {
          if (i === 0) {
            tooltip.innerHTML = '';          // no meaningful value for handle[0]
          } else {
            tooltip.innerHTML = diffs[i-1].toFixed(1);
          }
        }
      });
      updateConnectColors();
    });

    noUiSlider.create(extremitySlider, {
      start: [50],
      tooltips: [true],
      range: { min: 0, max: 100 }
    });

    const valuesDiv = document.getElementById('values');
    const updateValues = () => {
      const multiVals = multiSlider.noUiSlider.get().map(Number);
      const extVal = Number(extremitySlider.noUiSlider.get());
      valuesDiv.textContent = `Handles: ${multiVals.map(v => v.toFixed(1)).join(', ')} | Extremity: ${extVal.toFixed(1)}`;
    };

    multiSlider.noUiSlider.on('update', updateValues);
    extremitySlider.noUiSlider.on('update', updateValues);
    updateValues();

    const convoIdInput = document.getElementById('conversationId');
    const loadDataBtn = document.getElementById('loadData');
    const dataLinks = document.getElementById('dataLinks');
    const commentsUrl = document.getElementById('commentsUrl');
    const pcaUrl = document.getElementById('pcaUrl');
    const commentsInput = document.getElementById('commentsInput');
    const pcaInput = document.getElementById('pcaInput');
    const useDataBtn = document.getElementById('useData');
    const commentsTableContainer = document.getElementById('commentsTableContainer');
    const dataSection = document.getElementById('dataSection');

    loadDataBtn.addEventListener('click', () => {
      const id = convoIdInput.value.trim();
      if (!id) return alert('Please enter a conversation ID.');
      localStorage.setItem('conversationId', id);
      const commentsLink = `https://pol.is/api/v3/comments?conversation_id=${id}&moderation=true&include_voting_patterns=true`;
      const pcaLink = `https://pol.is/api/v3/math/pca2?conversation_id=${id}`;
      commentsUrl.href = commentsLink;
      pcaUrl.href = pcaLink;
      dataLinks.style.display = 'block';
    });

    useDataBtn.addEventListener('click', () => {
      if (!commentsInput.value.trim() || !pcaInput.value.trim()) {
        return alert('Please paste both JSON data.');
      }
      try {
        localStorage.setItem('commentsJSON', commentsInput.value);
        localStorage.setItem('pcaJSON', pcaInput.value);
        const comments = JSON.parse(commentsInput.value);
        dataSection.open = false;

        let html = '<table><thead><tr><th>ID</th><th>Text</th><th>Agree</th><th>Disagree</th><th>Pass</th></tr></thead><tbody>';
        comments.forEach(c => {
          html += `<tr data-agree='${c.agree_count}' data-disagree='${c.disagree_count}' data-pass='${c.pass_count}'>` +
                  `<td>${c.tid}</td><td>${c.txt}</td><td>${c.agree_count}</td><td>${c.disagree_count}</td><td>${c.pass_count}</td></tr>`;
        });
        html += '</tbody></table>';
        commentsTableContainer.innerHTML = html;

        commentsTableContainer.querySelectorAll('tr[data-agree]').forEach(row => {
          row.addEventListener('click', () => {
            const agree = Number(row.dataset.agree);
            const disagree = Number(row.dataset.disagree);
            const pass = Number(row.dataset.pass);
            const total = agree + disagree + pass;
            // Set slider: 0, agree, agree+pass, total (or 100) depending on total
            multiSlider.noUiSlider.set([0, agree, agree + pass, 100]);
          });
        });

      } catch(e) {
        alert('Invalid JSON data');
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Polis Metric Playground</title>
  <link href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css" rel="stylesheet">
  <style>
    body {
      font-family: sans-serif;
      padding: 2em;
      background: #fafafa;
    }
    details {
      background: #fff;
      border: 1px solid #ccc;
      padding: 1em;
      border-radius: 6px;
      margin-bottom: 1.5em;
    }
    .links {
      display: flex;
      gap: 1em;
    }
    .slider-wrapper {
      margin-bottom: 2em;
    }
    #multiSlider, #extremitySlider {
      margin-top: 1em;
    }
    .output {
      background: #fff;
      border: 1px solid #ccc;
      padding: 1em;
      border-radius: 6px;
    }
    textarea {
      width: 100%;
      min-height: 100px;
      margin-top: 0.5em;
    }
    button {
      margin-top: 0.5em;
      padding: 0.5em 1em;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Polis Metric Playground</h1>
  <p>Experiment with sliders to see how values affect the Polis importance and priority metrics. Values persist locally between refreshes.</p>

  <details id="dataSection" open>
    <summary><strong>Load Polis Data</strong></summary>
    <label for="conversationId">Conversation ID:</label><br>
    <input type="text" id="conversationId" placeholder="e.g. 6bkf4ujff9" style="width:200px;" /><br>

    <button id="loadData">Generate URLs</button>

    <div id="dataLinks" style="display:none; margin-top:1em;">
      <div class="links">
        <p><a id="commentsUrl" href="#" target="_blank" rel="noreferrer noopener">Comments JSON</a></p>
        <p><a id="pcaUrl" href="#" target="_blank" rel="noreferrer noopener">PCA2 JSON</a></p>
      </div>
      <textarea id="dataInput" placeholder="Paste JSON response here..."></textarea><br>
      <button id="useData">Use Data</button>
    </div>
  </details>

  <div class="slider-wrapper">
    <label>Response Distribution</label>
    <div id="multiSlider"></div>
  </div>

  <div class="slider-wrapper">
    <label>Extremity Weight</label>
    <div id="extremitySlider"></div>
  </div>

  <div class="output">
    <strong>Values:</strong>
    <div id="values"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>
  <script>
    const multiSlider = document.getElementById('multiSlider');
    const extremitySlider = document.getElementById('extremitySlider');

    const savedMulti = JSON.parse(localStorage.getItem('multiSliderValues')) || [20, 50, 80];
    const savedExt = JSON.parse(localStorage.getItem('extremityValue')) || 50;

    noUiSlider.create(multiSlider, {
      start: savedMulti,
      connect: [false, true, true, false],
      tooltips: [true, true, true],
      range: { 'min': 0, 'max': 100 },
      step: 1
    });

    noUiSlider.create(extremitySlider, {
      start: [savedExt],
      tooltips: [true],
      range: { 'min': 0, 'max': 100 }
    });

    function mergeTooltips(slider, threshold, separator) {
      const textIsRtl = getComputedStyle(slider).direction === 'rtl';
      const isRtl = slider.noUiSlider.options.direction === 'rtl';
      const isVertical = slider.noUiSlider.options.orientation === 'vertical';
      const tooltips = slider.noUiSlider.getTooltips();
      const origins = slider.noUiSlider.getOrigins();

      tooltips.forEach((tooltip, index) => {
        if (tooltip) origins[index].appendChild(tooltip);
      });

      slider.noUiSlider.on('update', (values, handle, unencoded, tap, positions) => {
        const pools = [[]], poolPositions = [[]], poolValues = [[]];
        let atPool = 0;

        if (tooltips[0]) {
          pools[0][0] = 0;
          poolPositions[0][0] = positions[0];
          poolValues[0][0] = values[0];
        }

        for (let i = 1; i < positions.length; i++) {
          if (!tooltips[i] || (positions[i] - positions[i - 1]) > threshold) {
            atPool++;
            pools[atPool] = [];
            poolValues[atPool] = [];
            poolPositions[atPool] = [];
          }
          if (tooltips[i]) {
            pools[atPool].push(i);
            poolValues[atPool].push(values[i]);
            poolPositions[atPool].push(positions[i]);
          }
        }

        pools.forEach((pool, poolIndex) => {
          const handlesInPool = pool.length;
          for (let j = 0; j < handlesInPool; j++) {
            const handleNumber = pool[j];
            if (j === handlesInPool - 1) {
              let offset = 0;
              poolPositions[poolIndex].forEach(v => offset += 1000 - v);
              const direction = isVertical ? 'bottom' : 'right';
              const last = isRtl ? 0 : handlesInPool - 1;
              const lastOffset = 1000 - poolPositions[poolIndex][last];
              offset = (textIsRtl && !isVertical ? 100 : 0) + (offset / handlesInPool) - lastOffset;
              tooltips[handleNumber].innerHTML = poolValues[poolIndex].join(separator);
              tooltips[handleNumber].style.display = 'block';
              tooltips[handleNumber].style[direction] = offset + '%';
            } else {
              tooltips[handleNumber].style.display = 'none';
            }
          }
        });
      });
    }

    mergeTooltips(multiSlider, 15, ' | ');

    const valuesDiv = document.getElementById('values');

    const updateValues = () => {
      const multiValues = multiSlider.noUiSlider.get().map(Number);
      const extValue = Number(extremitySlider.noUiSlider.get());
      localStorage.setItem('multiSliderValues', JSON.stringify(multiValues));
      localStorage.setItem('extremityValue', JSON.stringify(extValue));
      valuesDiv.textContent = `Handles: ${multiValues.map(v => v.toFixed(1)).join(', ')} | Extremity: ${extValue.toFixed(1)}`;
    };

    multiSlider.noUiSlider.on('update', updateValues);
    extremitySlider.noUiSlider.on('update', updateValues);

    updateValues();

    const convoIdInput = document.getElementById('conversationId');
    const loadDataBtn = document.getElementById('loadData');
    const dataLinks = document.getElementById('dataLinks');
    const commentsUrl = document.getElementById('commentsUrl');
    const pcaUrl = document.getElementById('pcaUrl');
    const dataInput = document.getElementById('dataInput');
    const useDataBtn = document.getElementById('useData');
    const dataSection = document.getElementById('dataSection');

    loadDataBtn.addEventListener('click', () => {
      const id = convoIdInput.value.trim();
      if (!id) return alert('Please enter a conversation ID.');
      const commentsLink = `https://pol.is/api/v3/comments?conversation_id=${id}&moderation=true&include_voting_patterns=true`;
      const pcaLink = `https://pol.is/api/v3/math/pca2?conversation_id=${id}`;
      commentsUrl.href = commentsLink;
      pcaUrl.href = pcaLink;
      dataLinks.style.display = 'block';
    });

    useDataBtn.addEventListener('click', () => {
      if (!dataInput.value.trim()) return alert('Please paste JSON data first.');
      try {
        const parsed = JSON.parse(dataInput.value);
        console.log('Loaded Polis data sample:', parsed);
        dataSection.open = false;
      } catch (e) {
        alert('Invalid JSON.');
      }
    });
  </script>
</body>
</html>

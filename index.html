<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Polis Metric Playground</title>
  <link href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css" rel="stylesheet">
  <style>
    body {
      font-family: sans-serif;
      padding: 2em;
      background: #fafafa;
    }
    .slider-wrapper {
      margin-bottom: 2em;
    }
    #multiSlider, #extremitySlider {
      margin-top: 1em;
    }
    .output {
      background: #fff;
      border: 1px solid #ccc;
      padding: 1em;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <h1>Polis Metric Playground</h1>
  <p>Experiment with a multi-handle slider to represent multiple response types.</p>

  <div class="slider-wrapper">
    <label>Response Distribution</label>
    <div id="multiSlider"></div>
  </div>

  <div class="slider-wrapper">
    <label>Extremity Weight</label>
    <div id="extremitySlider"></div>
  </div>

  <div class="output">
    <strong>Values:</strong>
    <div id="values"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>
  <script>
    const multiSlider = document.getElementById('multiSlider');

    noUiSlider.create(multiSlider, {
      start: [20, 50, 80],
      connect: [false, true, true, false],
      tooltips: [true, true, true],
      range: { 'min': 0, 'max': 100 },
      step: 1
    });

    const extremitySlider = document.getElementById('extremitySlider');
    noUiSlider.create(extremitySlider, {
      start: [50],
      tooltips: [true],
      range: { 'min': 0, 'max': 100 }
    });

    function mergeTooltips(slider, threshold, separator) {
      const textIsRtl = getComputedStyle(slider).direction === 'rtl';
      const isRtl = slider.noUiSlider.options.direction === 'rtl';
      const isVertical = slider.noUiSlider.options.orientation === 'vertical';
      const tooltips = slider.noUiSlider.getTooltips();
      const origins = slider.noUiSlider.getOrigins();

      tooltips.forEach((tooltip, index) => {
        if (tooltip) origins[index].appendChild(tooltip);
      });

      slider.noUiSlider.on('update', (values, handle, unencoded, tap, positions) => {
        const pools = [[]], poolPositions = [[]], poolValues = [[]];
        let atPool = 0;

        if (tooltips[0]) {
          pools[0][0] = 0;
          poolPositions[0][0] = positions[0];
          poolValues[0][0] = values[0];
        }

        for (let i = 1; i < positions.length; i++) {
          if (!tooltips[i] || (positions[i] - positions[i - 1]) > threshold) {
            atPool++;
            pools[atPool] = [];
            poolValues[atPool] = [];
            poolPositions[atPool] = [];
          }
          if (tooltips[i]) {
            pools[atPool].push(i);
            poolValues[atPool].push(values[i]);
            poolPositions[atPool].push(positions[i]);
          }
        }

        pools.forEach((pool, poolIndex) => {
          const handlesInPool = pool.length;
          for (let j = 0; j < handlesInPool; j++) {
            const handleNumber = pool[j];
            if (j === handlesInPool - 1) {
              let offset = 0;
              poolPositions[poolIndex].forEach(v => offset += 1000 - v);
              const direction = isVertical ? 'bottom' : 'right';
              const last = isRtl ? 0 : handlesInPool - 1;
              const lastOffset = 1000 - poolPositions[poolIndex][last];
              offset = (textIsRtl && !isVertical ? 100 : 0) + (offset / handlesInPool) - lastOffset;
              tooltips[handleNumber].innerHTML = poolValues[poolIndex].join(separator);
              tooltips[handleNumber].style.display = 'block';
              tooltips[handleNumber].style[direction] = offset + '%';
            } else {
              tooltips[handleNumber].style.display = 'none';
            }
          }
        });
      });
    }

    mergeTooltips(multiSlider, 15, ' | ');

    const valuesDiv = document.getElementById('values');
    const updateValues = () => {
      const [a, b, c] = multiSlider.noUiSlider.get().map(Number);
      const ext = Number(extremitySlider.noUiSlider.get());
      valuesDiv.textContent = `Handles: ${a.toFixed(1)}, ${b.toFixed(1)}, ${c.toFixed(1)} | Extremity: ${ext.toFixed(1)}`;
    };

    multiSlider.noUiSlider.on('update', updateValues);
    extremitySlider.noUiSlider.on('update', updateValues);

    updateValues();
  </script>
</body>
</html>
